# Smart Context - æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†

> **è®¾è®¡æ–¹æ¡ˆ v0.5.0** - å®Œå…¨è‡ªåŠ¨åŒ–æ–¹æ¡ˆ

---

## 1. é—®é¢˜ä¸è§£æ³•

### 1.1 æ ¸å¿ƒé—®é¢˜

```
å¢é‡æ—¥å¿—ç§¯ç´¯ â†’ 90% å™ªéŸ³ï¼ˆåºŸå¼ƒä»£ç ã€é”™è¯¯å †æ ˆã€å¤±è´¥å°è¯•ï¼‰
            â†’ æ³¨æ„åŠ›ç¨€é‡Šï¼ˆAttention Dilutionï¼‰
            â†’ å¿˜è®°ç›®æ ‡ / é‡å¤è¸©å‘
```

### 1.2 è§£å†³æ€è·¯

**ä¸æ˜¯å‹ç¼©ï¼Œè€Œæ˜¯æŠ˜å  + å¿«ç…§**ï¼š

```
å¢é‡æ—¥å¿—ï¼ˆå‡ ä¸‡ Tokenï¼‰â”€â”€Squashâ”€â”€â–¶ çƒ­è½¨å¿«ç…§ï¼ˆ< 6k Tokenï¼‰
```

---

## 2. åŒè½¨åˆ¶è®°å¿†

### 2.1 æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”¥ çƒ­è½¨ (Hot Track)                                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ å®¹é‡ï¼š< 6,000 Token                                       â”‚
â”‚  â€¢ å½¢å¼ï¼šHOT_TRACK.md æ–‡ä»¶                                   â”‚
â”‚  â€¢ å†…å®¹ï¼šé¡¹ç›®çŠ¶æ€ + æ¥å£éª¨æ¶ + é¿å‘å¢“ç¢‘ + å…³é”®å†³ç­–             â”‚
â”‚  â€¢ ç‰¹ç‚¹ï¼šå‹ç¼©åè‡ªåŠ¨æ³¨å…¥ï¼ˆé€šè¿‡ SessionStart Hookï¼‰             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â„ï¸ å†·è½¨ (Cold Track)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â€¢ å®¹é‡ï¼šæ— é™                                                 â”‚
â”‚  â€¢ å½¢å¼ï¼šCOLD_TRACK.md æ–‡ä»¶                                  â”‚
â”‚  â€¢ å†…å®¹ï¼šå®Œæ•´å†å² + å¢“ç¢‘è¯¦æƒ…                                  â”‚
â”‚  â€¢ ç‰¹ç‚¹ï¼šæŒ‰éœ€æŸ¥è¯¢ï¼ˆ/query-coldï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–‡ä»¶ç»“æ„

```
# ç”¨æˆ·ç›®å½•ï¼ˆå…¨å±€é…ç½®ï¼Œéœ€æ‰‹åŠ¨å®‰è£…ï¼‰
~/.claude/
â”œâ”€â”€ settings.json           # Hooks é…ç½®
â””â”€â”€ hooks/
    â””â”€â”€ inject-hot-track.js # SessionStart Hook è„šæœ¬

# é¡¹ç›®ç›®å½•ï¼ˆè¿è¡Œæ—¶è‡ªåŠ¨ç”Ÿæˆï¼‰
your-project/.claude/
â””â”€â”€ context/                # è‡ªåŠ¨åˆ›å»º
    â”œâ”€â”€ HOT_TRACK.md        # çƒ­è½¨å¿«ç…§ï¼ˆå½“å‰çŠ¶æ€ï¼Œ< 6k Tokenï¼‰
    â”œâ”€â”€ COLD_TRACK.md       # å†·è½¨å½’æ¡£ï¼ˆå®Œæ•´å†å² + å¢“ç¢‘è¯¦æƒ…ï¼‰
    â””â”€â”€ COMPACT_LOG.md      # å‹ç¼©æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
```

---

## 3. è‡ªåŠ¨åŒ–æ–¹æ¡ˆ

### 3.1 æ ¸å¿ƒæœºåˆ¶

é€šè¿‡ **PreCompact Hook** + **SessionStart Hook** å®ç°å®Œå…¨è‡ªåŠ¨åŒ–ï¼š

| Hook | è§¦å‘æ—¶æœº | ä½œç”¨ |
|------|----------|------|
| **PreCompact** | å‹ç¼©å‰ | åˆ†æä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆçƒ­è½¨å¿«ç…§ |
| **SessionStart** (compact) | å‹ç¼©å | è¯»å–å¿«ç…§ï¼Œè‡ªåŠ¨æ³¨å…¥åˆ°æ–°ä¼šè¯ |

### 3.2 å·¥ä½œæµç¨‹ï¼ˆå®Œå…¨è‡ªåŠ¨åŒ–ï¼‰

```
ç”¨æˆ·æ‰§è¡Œ /compact
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. PreCompact Hook è§¦å‘                                     â”‚
â”‚                                                             â”‚
â”‚    â€¢ è¯»å– transcriptï¼ˆå¯¹è¯å†å²ï¼‰                             â”‚
â”‚    â€¢ æ‰§è¡Œä¸‰æ­¥æ¸…æ´—æ³•ï¼š                                        â”‚
â”‚      - æ— æŸæå–ï¼ˆæŠ½éª¨æ¶ï¼‰                                    â”‚
â”‚      - æœ‰æŸä¿®å‰ªï¼ˆç«‹å¢“ç¢‘ï¼‰                                    â”‚
â”‚      - ç”Ÿæˆå¿«ç…§ + å½’æ¡£                                      â”‚
â”‚    â€¢ ç”Ÿæˆæ–‡ä»¶ï¼š                                              â”‚
â”‚      - .claude/context/HOT_TRACK.mdï¼ˆçƒ­è½¨å¿«ç…§ï¼‰              â”‚
â”‚      - .claude/context/COLD_TRACK.mdï¼ˆå†·è½¨å½’æ¡£ï¼Œè¿½åŠ ï¼‰       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   å‹ç¼©æ‰§è¡Œï¼ˆClaude Code å†…ç½®ï¼‰
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SessionStart Hook è§¦å‘ï¼ˆcompact_session: trueï¼‰          â”‚
â”‚                                                             â”‚
â”‚    â€¢ æ£€æµ‹ compact_session: true                             â”‚
â”‚    â€¢ è¯»å– .claude/context/HOT_TRACK.md                      â”‚
â”‚    â€¢ è¾“å‡ºå†…å®¹åˆ° stdout                                      â”‚
â”‚    â€¢ stdout å†…å®¹è‡ªåŠ¨æ³¨å…¥åˆ°å‹ç¼©åçš„ä¼šè¯ï¼                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‹ç¼©å®Œæˆï¼Œçƒ­è½¨å¿«ç…§å·²è‡ªåŠ¨æ³¨å…¥                                 â”‚
â”‚                                                             â”‚
â”‚ Claude çœ‹åˆ°çš„ä¸Šä¸‹æ–‡ï¼š                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [å‹ç¼©åçš„å†å²æ‘˜è¦]                                       â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ [çƒ­è½¨å¿«ç…§å†…å®¹ - æ¥è‡ª SessionStart stdout]  â† è‡ªåŠ¨æ³¨å…¥   â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ # çƒ­è½¨å¿«ç…§                                              â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ ## 1. é¡¹ç›®çŠ¶æ€                                          â”‚ â”‚
â”‚ â”‚ å½“å‰ç›®æ ‡ï¼šå®ç°ç”¨æˆ·ç™»å½•ç³»ç»Ÿ                               â”‚ â”‚
â”‚ â”‚ å½“ä¸‹é˜»å¡ï¼šOAuth-GitHub 403 é”™è¯¯                         â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ ## 2. å·²ç¡®å®šæ¥å£                                        â”‚ â”‚
â”‚ â”‚ AuthService: register, login, validateToken...          â”‚ â”‚
â”‚ â”‚                                                         â”‚ â”‚
â”‚ â”‚ ## 3. é¿å‘å¢“ç¢‘                                          â”‚ â”‚
â”‚ â”‚ Session å­˜å‚¨ â†’ åˆ†å¸ƒå¼é—®é¢˜ï¼ˆå·²æ”¾å¼ƒï¼‰                      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
   ç”¨æˆ·ç»§ç»­å·¥ä½œï¼ˆä¸Šä¸‹æ–‡æ¸…æ™°ï¼‰
```

### 3.3 è‡ªåŠ¨åŒ–ç¨‹åº¦

```
ç”¨æˆ·åªéœ€ï¼š/compact

è‡ªåŠ¨å®Œæˆï¼š
âœ… PreCompact ç”Ÿæˆçƒ­è½¨å¿«ç…§
âœ… å‹ç¼©æ‰§è¡Œ
âœ… SessionStart è‡ªåŠ¨æ³¨å…¥å¿«ç…§

è‡ªåŠ¨åŒ–ç¨‹åº¦ï¼š100%
```

---

## 4. Hooks é…ç½®

### 4.1 é…ç½®æ–‡ä»¶

åœ¨ `.claude/settings.json` ä¸­é…ç½®ï¼ˆå®Œæ•´é…ç½®è§ `hooks/hooks-config.json`ï¼‰ï¼š

```json
{
  "hooks": {
    "PreCompact": [
      {
        "matcher": "manual",
        "hooks": [
          {
            "type": "agent",
            "name": "smart-context-snapshot",
            "prompt": "è¯¦è§ hooks/hooks-config.json ä¸­çš„å®Œæ•´ prompt"
          }
        ]
      }
    ],
    "SessionStart": [
      {
        "matcher": "compact",
        "hooks": [
          {
            "type": "command",
            "command": "node \"${CLAUDE_CONFIG_DIR}/hooks/inject-hot-track.js\""
          }
        ]
      }
    ]
  }
}
```

> **æ³¨æ„**ï¼šPreCompact çš„ prompt è¾ƒé•¿ï¼Œè¯·ç›´æ¥å¤åˆ¶ `hooks/hooks-config.json` ä¸­çš„å®Œæ•´å†…å®¹ã€‚

### 4.2 inject-hot-track.js è„šæœ¬

å®Œæ•´è„šæœ¬è§ `hooks/inject-hot-track.js`ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š

```javascript
#!/usr/bin/env node
/**
 * SessionStart Hook: å‹ç¼©åè‡ªåŠ¨æ³¨å…¥çƒ­è½¨å¿«ç…§
 *
 * è§¦å‘æ¡ä»¶ï¼šmatcher: "compact" (å‹ç¼©åçš„ä¼šè¯å¯åŠ¨)
 * è¾“å…¥ï¼šåŒ…å« compact_session: true çš„ JSON
 * è¾“å‡ºï¼šstdout å†…å®¹ä¼šè¢«æ³¨å…¥åˆ°æ–°ä¼šè¯
 */

const fs = require('fs');
const path = require('path');

// è¯»å– Hook è¾“å…¥
let input = '';
process.stdin.on('data', chunk => input += chunk);
process.stdin.on('end', () => {
  try {
    const data = JSON.parse(input);

    // åªå¤„ç†å‹ç¼©åçš„ä¼šè¯
    if (!data.compact_session) {
      process.exit(0);
    }

    const hotTrackPath = path.join(data.cwd, '.claude', 'context', 'HOT_TRACK.md');

    if (fs.existsSync(hotTrackPath)) {
      const content = fs.readFileSync(hotTrackPath, 'utf8');
      // è¾“å‡ºåˆ° stdout = æ³¨å…¥åˆ°ä¼šè¯
      console.log(content);
    }
  } catch (error) {
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“å‹ç¼©æµç¨‹
  }
});
```

---

## 5. å‘½ä»¤ä½“ç³»

### 5.1 å‘½ä»¤åˆ—è¡¨

| å‘½ä»¤ | åŠŸèƒ½ | å¿…éœ€æ€§ |
|------|------|--------|
| `/compact` | å‹ç¼© + è‡ªåŠ¨ç”Ÿæˆå¿«ç…§ + è‡ªåŠ¨æ³¨å…¥ | **ä¸»è¦ä½¿ç”¨** |
| `/smart-context` | æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§ï¼ˆè°ƒè¯•ç”¨ï¼‰ | å¯é€‰ |
| `/load-context` | æ‰‹åŠ¨åŠ è½½å¿«ç…§ï¼ˆè°ƒè¯•ç”¨ï¼‰ | å¯é€‰ |
| `/query-cold` | æŸ¥è¯¢å†·è½¨å†å² | å¯é€‰ |

### 5.2 ä½¿ç”¨åœºæ™¯

**æ­£å¸¸ä½¿ç”¨ï¼ˆè‡ªåŠ¨åŒ–ï¼‰**ï¼š
```
ç”¨æˆ·: /compact
Claude: [è‡ªåŠ¨ç”Ÿæˆå¿«ç…§] â†’ [å‹ç¼©] â†’ [è‡ªåŠ¨æ³¨å…¥å¿«ç…§] â†’ ç»§ç»­å·¥ä½œ
```

**æ‰‹åŠ¨ç”Ÿæˆå¿«ç…§ï¼ˆè°ƒè¯•/é¢„è§ˆï¼‰**ï¼š
```
ç”¨æˆ·: /smart-context
Claude: ç”Ÿæˆå¿«ç…§ï¼Œæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
```

**æŸ¥è¯¢å†å²**ï¼š
```
ç”¨æˆ·: /query-cold "Session"
Claude: æœç´¢å†·è½¨ï¼Œè¿”å›ç›¸å…³å¢“ç¢‘å’Œå†å²ç‰‡æ®µ
```

---

## 6. çƒ­è½¨å¿«ç…§ç»“æ„

### 6.1 æ¨¡æ¿

```markdown
# çƒ­è½¨å¿«ç…§

_ç”Ÿæˆæ—¶é—´: YYYY-MM-DD HH:MM_
_å¿«ç…§ç‰ˆæœ¬: v{N}_

---

## 1. é¡¹ç›®çŠ¶æ€

### å½“å‰ç›®æ ‡
[ä¸€å¥è¯æè¿°]

### è¿›åº¦æ¦‚è§ˆ
| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ... | ... | ... |

### å½“ä¸‹é˜»å¡
- **é—®é¢˜**: [æè¿°]
- **ä¸‹ä¸€æ­¥**: [è®¡åˆ’]

---

## 2. å·²ç¡®å®šæ¥å£ï¼ˆéª¨æ¶ï¼‰

### {æ–‡ä»¶å}.ts
```typescript
// å‡½æ•°ç­¾åï¼ˆæ— å®ç°ä½“ï¼‰
function name(params: Type): ReturnType
class ClassName { method(): ReturnType }
```

---

## 3. é¿å‘å¢“ç¢‘

| æ­»èƒ¡åŒ | å¤±è´¥åŸå›  | æ—¥æœŸ |
|--------|----------|------|
| [æ–¹æ¡ˆ] | [ä¸€å¥è¯] | [æ—¥æœŸ] |

---

## 4. å…³é”®å†³ç­–

| å†³ç­– | ç†ç”± | æ—¥æœŸ |
|------|------|------|
| [é€‰æ‹©] | [åŸå› ] | [æ—¥æœŸ] |

---
*Token æ•°: ~{N}*
```

### 6.2 å¤§å°æ§åˆ¶

**ä¸Šé™**ï¼š6,000 Token

**Token ä¼°ç®—è§„åˆ™**ï¼ˆæ··åˆè®¡ç®—ï¼‰ï¼š

```python
def estimate_tokens(text: str) -> int:
    """
    æ··åˆ Token ä¼°ç®—ï¼š
    - è‹±æ–‡/ä»£ç /ç¬¦å·ï¼š1 Token â‰ˆ 4 å­—ç¬¦
    - ä¸­æ–‡/æ—¥æ–‡/éŸ©æ–‡ï¼š1 Token â‰ˆ 1.5 å­—ç¬¦
    """
    chinese_chars = count_chinese(text)
    other_chars = len(text) - chinese_chars

    tokens = (chinese_chars / 1.5) + (other_chars / 4)
    return int(tokens)
```

**è£å‰ªä¼˜å…ˆçº§**ï¼ˆæ¥è¿‘ä¸Šé™æ—¶ï¼‰ï¼š

| ä¼˜å…ˆçº§ | å†…å®¹ | åŠ¨ä½œ |
|--------|------|------|
| 1 | é¡¹ç›®ç›®æ ‡ + é˜»å¡ | å®Œæ•´ä¿ç•™ |
| 2 | æ¥å£éª¨æ¶ | å‹ç¼©ï¼ˆåˆ é™¤å‚æ•°è¯¦æƒ…ï¼‰ |
| 3 | é¿å‘å¢“ç¢‘ | å‹ç¼©ï¼ˆåªä¿ç•™æ­»èƒ¡åŒ+åŸå› ï¼‰ |
| 4 | å…³é”®å†³ç­– | å¯åˆ é™¤ |
| 5 | è¿›åº¦æ¦‚è§ˆ | å¯åˆ é™¤ |

---

## 7. å†·è½¨å½’æ¡£ç»“æ„

### 7.1 æ¨¡æ¿

```markdown
# å†·è½¨å½’æ¡£

_åˆ›å»ºæ—¶é—´: YYYY-MM-DD_

---

## å¢“ç¢‘åŒº

### T01: [æ­»èƒ¡åŒåç§°]
- **å¤±è´¥åŸå› **: [æè¿°]
- **æ”¾å¼ƒæ—¥æœŸ**: YYYY-MM-DD
- **å°è¯•è¿‡ç¨‹**:
  [è¯¦ç»†çš„å¤±è´¥è¿‡ç¨‹è®°å½•]

---

## å†å²è®°å½•åŒº

### Session: YYYY-MM-DD

#### Turn 1 - HH:MM
**User**: [å†…å®¹]
**Assistant**: [å†…å®¹]
**Tools**: [å·¥å…·è°ƒç”¨]

#### Turn 2 - HH:MM
...

---

## ç»Ÿè®¡
- æ€»äº¤äº’æ•°: {N}
- å¢“ç¢‘æ•°: {M}
- æœ€æ—©è®°å½•: YYYY-MM-DD
```

---

## 8. ä¸‰æ­¥æ¸…æ´—æ³•

### 8.1 æµç¨‹å›¾

```
PreCompact Hook è§¦å‘
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ— æŸæå– â€” æŠ½éª¨æ¶                            â”‚
â”‚                                                     â”‚
â”‚ â€¢ è¯†åˆ«æ‰€æœ‰ä»£ç ç›¸å…³å†…å®¹                               â”‚
â”‚ â€¢ æå–æœ€ç»ˆç‰ˆæœ¬çš„æ¥å£ç­¾åï¼ˆPrompt é©±åŠ¨ï¼‰               â”‚
â”‚ â€¢ å‡½æ•°åã€å‚æ•°ã€è¿”å›ç±»å‹                             â”‚
â”‚ â€¢ API ç«¯ç‚¹ã€æ•°æ®æ¨¡å‹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æœ‰æŸä¿®å‰ª â€” ç«‹å¢“ç¢‘                            â”‚
â”‚                                                     â”‚
â”‚ â€¢ è¯†åˆ«"å‡è®¾ â†’ å°è¯• â†’ å¤±è´¥ â†’ æ”¾å¼ƒ"çš„æ­»èƒ¡åŒ            â”‚
â”‚ â€¢ ç”Ÿæˆå¢“ç¢‘ï¼ˆä¸€å¥è¯è¯´æ˜å¤±è´¥åŸå› ï¼‰                      â”‚
â”‚ â€¢ è¯¦ç»†è¿‡ç¨‹å†™å…¥å†·è½¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: ç”Ÿæˆå¿«ç…§ + å½’æ¡£                              â”‚
â”‚                                                     â”‚
â”‚ â€¢ ç»„è£…çƒ­è½¨å¿«ç…§ï¼ˆæ£€æŸ¥ Token ä¸Šé™ï¼‰                    â”‚
â”‚ â€¢ å†™å…¥ HOT_TRACK.md                                 â”‚
â”‚ â€¢ è¿½åŠ å†å²åˆ° COLD_TRACK.md                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 æ­»èƒ¡åŒè¯†åˆ«æ¨¡å¼

```markdown
ä¿¡å·è¯ï¼š
- å‡è®¾æå‡ºï¼š"è¯•è¯•"ã€"ä¹Ÿè®¸"ã€"å°è¯•ä¸€ä¸‹"
- å°è¯•å®æ–½ï¼š"æˆ‘æ”¹äº†"ã€"ä¿®æ”¹ä¸º"ã€"å®ç°äº†ä¸€ä¸‹"
- æ˜ç¡®å¤±è´¥ï¼š"ä¸è¡Œ"ã€"è¿˜æ˜¯æŠ¥é”™"ã€"æ²¡è§£å†³"
- æ”¾å¼ƒæ–¹æ¡ˆï¼š"æ¢ä¸€ç§"ã€"æ”¹ç”¨"ã€"ç®—äº†"

åŒ¹é…æ¨¡å¼ï¼š[å‡è®¾] + [å°è¯•] + [å¤±è´¥] + [æ”¾å¼ƒ] = æ­»èƒ¡åŒ
```

---

## 9. å†·è½¨æŸ¥è¯¢

### 9.1 å‘½ä»¤

```
/query-cold "å…³é”®è¯"
```

### 9.2 æ‰§è¡Œæµç¨‹

```
1. åœ¨ COLD_TRACK.md ä¸­ç”¨ Grep æœç´¢å…³é”®è¯
2. è¿”å›åŒ¹é…çš„å¢“ç¢‘å’Œå†å²ç‰‡æ®µ
```

### 9.3 è¾“å‡ºç¤ºä¾‹

```markdown
> åœ¨å†·è½¨ä¸­æ‰¾åˆ° 2 æ¡ç›¸å…³è®°å½•ï¼š
>
> ## å¢“ç¢‘ T01
> **æ­»èƒ¡åŒ**: Session å­˜å‚¨ç™»å½•æ€
> **å¤±è´¥åŸå› **: åˆ†å¸ƒå¼éƒ¨ç½²æ—¶ Session åŒæ­¥é—®é¢˜
> **æ”¾å¼ƒæ—¥æœŸ**: 2026-02-21
>
> ## å†å²ç‰‡æ®µ (Turn 12-15)
> å°è¯•ä½¿ç”¨ express-sessionï¼Œä½†é‡åˆ°åˆ†å¸ƒå¼åŒæ­¥é—®é¢˜...
> è¯¦è§ COLD_TRACK.md#turn-12
```

---

## 10. å®ç°æ–‡ä»¶ç»“æ„

```
# Skill æºæ–‡ä»¶ï¼ˆæœ¬ä»“åº“ï¼‰
skills/
â””â”€â”€ smart-context/
    â”œâ”€â”€ SKILL.md                    # æ ¸å¿ƒæŠ€èƒ½å®šä¹‰
    â”œâ”€â”€ README.md                   # æœ¬è®¾è®¡æ–‡æ¡£
    â””â”€â”€ hooks/
        â”œâ”€â”€ hooks-config.json       # Hooks é…ç½®æ¨¡æ¿
        â”œâ”€â”€ inject-hot-track.js     # SessionStart Hook è„šæœ¬
        â””â”€â”€ README.md               # å®‰è£…è¯´æ˜

commands/
â”œâ”€â”€ smart-context.md                # æ‰‹åŠ¨åˆ›å»ºå¿«ç…§ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ load-context.md                 # æ‰‹åŠ¨åŠ è½½å¿«ç…§ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ query-cold.md                   # æŸ¥è¯¢å†·è½¨

# ç”¨æˆ·å®‰è£…ç›®å½•ï¼ˆæ‰‹åŠ¨å®‰è£…ï¼‰
~/.claude/
â”œâ”€â”€ settings.json                   # Hooks é…ç½®ï¼ˆä» hooks-config.json åˆå¹¶ï¼‰
â””â”€â”€ hooks/
    â””â”€â”€ inject-hot-track.js         # ä» skill å¤åˆ¶

# é¡¹ç›®è¿è¡Œæ—¶ç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
your-project/.claude/
â””â”€â”€ context/                        # è¿è¡Œæ—¶è‡ªåŠ¨åˆ›å»º
    â”œâ”€â”€ HOT_TRACK.md                # çƒ­è½¨å¿«ç…§
    â”œâ”€â”€ COLD_TRACK.md               # å†·è½¨å½’æ¡£
    â””â”€â”€ COMPACT_LOG.md              # å‹ç¼©æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
```

---

## 11. ç¡®è®¤çš„å†³ç­–

| # | å†³ç­–é¡¹ | ç»“è®º |
|---|--------|------|
| 1 | è‡ªåŠ¨åŒ–æ–¹æ¡ˆ | PreCompact + SessionStart (compact matcher) |
| 2 | ç”¨æˆ·æ“ä½œ | åªéœ€ `/compact`ï¼Œ100% è‡ªåŠ¨åŒ– |
| 3 | Token ä¼°ç®— | æ··åˆè®¡ç®—ï¼šè‹±æ–‡/4 + ä¸­æ–‡/1.5 |
| 4 | çƒ­è½¨å¤§å° | ä¸Šé™ 6,000 Token |
| 5 | éª¨æ¶æå– | çº¯ Prompt é©±åŠ¨ï¼ˆPreCompact Agent Hookï¼‰ |
| 6 | çƒ­è½¨æ³¨å…¥ | SessionStart stdout è‡ªåŠ¨æ³¨å…¥ |
| 7 | å†·è½¨å½’æ¡£ | å•æ–‡ä»¶ COLD_TRACK.md |
| 8 | å†·è½¨æŸ¥è¯¢ | Prompt + Grep |
| 9 | æ‰‹åŠ¨å‘½ä»¤ | ä¿ç•™ä½œä¸ºè°ƒè¯•/é¢„è§ˆé€‰é¡¹ |

---

## 12. å®ç°è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½

- [x] åˆ›å»º `skills/smart-context/SKILL.md`
- [x] åˆ›å»º `skills/smart-context/hooks/inject-hot-track.js`
- [x] åˆ›å»º `skills/smart-context/hooks/hooks-config.json`
- [x] é…ç½® Hooksï¼ˆPreCompact + SessionStartï¼‰
- [x] å®ç°ä¸‰æ­¥æ¸…æ´—æ³•ï¼ˆAgent Promptï¼‰
- [x] PreCompact ç”Ÿæˆ HOT_TRACK.md å’Œ COLD_TRACK.md

### Phase 2: å¯é€‰å‘½ä»¤

- [x] åˆ›å»º `commands/smart-context.md`ï¼ˆæ‰‹åŠ¨ç”Ÿæˆï¼‰
- [x] åˆ›å»º `commands/load-context.md`ï¼ˆæ‰‹åŠ¨åŠ è½½ï¼‰
- [x] åˆ›å»º `commands/query-cold.md`ï¼ˆæŸ¥è¯¢å†·è½¨ï¼‰

### Phase 3: ä¼˜åŒ–

- [ ] å‹ç¼©æ•ˆæœç»Ÿè®¡
- [ ] Token ä¼°ç®—ä¼˜åŒ–
- [ ] çƒ­è½¨å¤§å°åŠ¨æ€è°ƒæ•´

---

## 13. æŠ€æœ¯è¦ç‚¹

### 13.1 Hook æœºåˆ¶è¯´æ˜

| Hook ç±»å‹ | è¯´æ˜ |
|-----------|------|
| `PreCompact` | å‹ç¼©å‰è§¦å‘ï¼Œå¯æ‰§è¡Œ Agent åˆ†æä¸Šä¸‹æ–‡ |
| `SessionStart` + `matcher: "compact"` | å‹ç¼©åè§¦å‘ï¼Œ`compact_session: true` æ ‡è¯† |
| `stdout` è¾“å‡º | SessionStart çš„ stdout ä¼šè‡ªåŠ¨æ³¨å…¥åˆ°ä¼šè¯ |

### 13.2 æ•°æ®æµ

```
transcript.jsonl
      â”‚
      â–¼ (PreCompact è¯»å–)
Agent åˆ†æ
      â”‚
      â–¼ (ç”Ÿæˆ)
HOT_TRACK.md + COLD_TRACK.md
      â”‚
      â–¼ (SessionStart è¯»å–)
stdout è¾“å‡º
      â”‚
      â–¼ (è‡ªåŠ¨æ³¨å…¥)
å‹ç¼©åçš„ä¼šè¯ä¸Šä¸‹æ–‡
```

---

## å˜æ›´è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| v0.1.0 | 2026-02-23 | åˆå§‹æ–¹æ¡ˆ |
| v0.2.0 | 2026-02-23 | èå…¥ DTCC åŒè½¨è®°å¿†ç†è®º |
| v0.3.0 | 2026-02-23 | ç¡®å®šå®ç°æ–¹æ¡ˆï¼šé›¶è„šæœ¬ã€é¦–æ¶ˆæ¯æ³¨å…¥ã€æ··åˆTokenä¼°ç®— |
| v0.4.0 | 2026-02-23 | é‡å‘½åï¼šsmart-compact â†’ smart-context |
| v0.5.0 | 2026-02-23 | **å®Œå…¨è‡ªåŠ¨åŒ–**ï¼šPreCompact + SessionStart (compact matcher)ï¼Œç”¨æˆ·åªéœ€ /compact |

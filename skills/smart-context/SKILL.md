---
name: smart-context
description: 智能上下文管理，通过双轨记忆（热轨/冷轨）和三步清洗法解决注意力稀释问题。手动生成高信噪比快照，需要时手动加载。自动激活于压缩相关场景。
---

# Smart Context - 智能上下文管理

通过双轨记忆和三步清洗法解决长对话中的注意力稀释问题。

## 核心理念

**问题**：增量日志积累 → 90% 噪音 → 注意力稀释 → 忘记目标 / 重复踩坑

**解法**：折叠 + 快照，而非简单压缩

```
增量日志（几万 Token）──Squash──▶ 热轨快照（< 6k Token）
```

## Automatic Activation Triggers

This skill should be automatically activated when:

**Keywords:**
- compact, 压缩, 上下文, context
- 快照, snapshot, checkpoint
- 墓碑, tombstone, 死胡同, 避坑
- 注意力稀释, context window
- 热轨, 冷轨, hot track, cold track
- 之前试过, 历史方案, 为什么不行, 失败原因

**Example User Messages:**
- "上下文太长了" / "执行压缩" / "/compact"
- "生成一个快照" / "/context-snapshot"
- "之前试过什么方案？" / "我们尝试过什么？"
- "那个方案为什么不行？" / "XX方案失败的原因是？"
- "查一下冷轨" / "/query-cold"

**When NOT to Activate:**
- 用户只是问问题，不涉及上下文管理或历史查询
- 用户在讨论其他不相关的话题

## 双轨制记忆

### 热轨 (Hot Track)
- **容量**：< 6,000 Token
- **形式**：`.claude/context/HOT_TRACK.md`
- **内容**：项目状态 + 接口骨架 + 避坑墓碑 + 关键决策
- **特点**：手动生成，手动加载

### 冷轨 (Cold Track)
- **容量**：无限
- **形式**：`.claude/context/COLD_TRACK.md`
- **内容**：完整历史 + 墓碑详情
- **特点**：按需查询（通过 /query-cold）

## 文件结构

```
# 项目目录（每个项目独立）
your-project/.claude/
└── context/                   # 手动创建
    ├── HOT_TRACK.md           # 热轨快照（手动生成）
    └── COLD_TRACK.md          # 冷轨归档（手动生成）
```

## 工作流程

### 完全手动流程

```
1. /context-snapshot  →  生成快照（三步清洗法）
2. /compact           →  执行压缩
3. /load-context      →  新会话需要时手动加载快照
```

> **注意**：采用完全手动流程，避免旧快照污染新会话。

## 三步清洗法

### Step 1: 无损提取 — 抽骨架

**目标**：从杂乱对话中提取"沉淀下来的资产"

**提取规则**：

| 内容类型 | 提取方式 | 保留 |
|----------|----------|------|
| 函数定义 | 只保留签名 | `def calc(a: int, b: int) -> int` |
| 类定义 | 只保留属性和方法签名 | 删除方法体 |
| API 端点 | 只保留路由和参数定义 | 删除处理逻辑 |
| 数据模型 | 只保留字段定义 | 删除默认值逻辑 |

**执行过程**：
1. 扫描所有代码相关内容（工具调用、代码块）
2. 识别最终版本的接口（中间版本丢弃）
3. 提取函数签名、类型定义、API 路由
4. 生成骨架，不包含实现细节

### Step 2: 有损修剪 — 立墓碑

**目标**：识别失败尝试，生成避坑指南

**死胡同识别模式**：

```markdown
信号词：
- 假设提出："试试"、"也许"、"尝试一下"
- 尝试实施："我改了"、"修改为"、"实现了一下"
- 明确失败："不行"、"还是报错"、"没解决"
- 放弃方案："换一种"、"改用"、"算了"

匹配模式：[假设] + [尝试] + [失败] + [放弃] = 死胡同
```

**墓碑格式**：

```markdown
| 死胡同 | 失败原因 | 日期 |
|--------|----------|------|
| [方案名称] | [一句话说明为什么不行] | [日期] |
```

**执行过程**：
1. 遍历对话历史，识别死胡同模式
2. 为每个死胡同生成墓碑（< 50 字）
3. 将详细失败过程写入冷轨
4. 保留墓碑到热轨

### Step 3: 生成快照 + 归档

**目标**：组装热轨快照，确保大小可控

**Token 估算规则**：

```python
def estimate_tokens(text: str) -> int:
    """
    混合 Token 估算：
    - 英文/代码/符号：1 Token ≈ 4 字符
    - 中文/日文/韩文：1 Token ≈ 1.5 字符
    """
    chinese_chars = count_chinese(text)  # Unicode: \u4e00-\u9fff
    other_chars = len(text) - chinese_chars
    tokens = (chinese_chars / 1.5) + (other_chars / 4)
    return int(tokens)
```

**裁剪优先级**（接近 6,000 Token 上限时）：

| 优先级 | 内容 | 动作 |
|--------|------|------|
| 1 | 项目目标 + 阻塞 | 完整保留 |
| 2 | 接口骨架 | 压缩（删除参数详情） |
| 3 | 避坑墓碑 | 压缩（只保留死胡同+原因） |
| 4 | 关键决策 | 可删除 |
| 5 | 进度概览 | 可删除 |

**执行过程**：
1. 组装热轨快照（项目状态 + 接口骨架 + 墓碑 + 决策）
2. 估算 Token 数
3. 如果超限，按优先级裁剪
4. 写入 `.claude/context/HOT_TRACK.md`
5. 追加完整历史到 `.claude/context/COLD_TRACK.md`

## 热轨快照模板

```markdown
# 热轨快照

_生成时间: YYYY-MM-DD HH:MM_
_快照版本: v{N}_

---

## 1. 项目状态

### 当前目标
[一句话描述]

### 进度概览
| 模块 | 状态 | 说明 |
|------|------|------|
| ... | ... | ... |

### 当下阻塞
- **问题**: [描述]
- **下一步**: [计划]

---

## 2. 已确定接口（骨架）

### {文件名}
```
[接口签名，无实现体]
```

---

## 3. 避坑墓碑

| 死胡同 | 失败原因 | 日期 |
|--------|----------|------|
| [方案] | [一句话] | [日期] |

---

## 4. 关键决策

| 决策 | 理由 | 日期 |
|------|------|------|
| [选择] | [原因] | [日期] |

---
*Token 数: ~{N}*
```

## 冷轨归档模板

```markdown
# 冷轨归档

_创建时间: YYYY-MM-DD_

---

## 墓碑区

### T01: [死胡同名称]
- **失败原因**: [描述]
- **放弃日期**: YYYY-MM-DD
- **尝试过程**:
  [详细的失败过程记录]

---

## 历史记录区

### Session: YYYY-MM-DD

#### Turn 1 - HH:MM
**User**: [内容]
**Assistant**: [内容]
**Tools**: [工具调用]

---

## 统计
- 总交互数: {N}
- 墓碑数: {M}
- 最早记录: YYYY-MM-DD
```

## Actions

### 1. 生成快照

```
/context-snapshot

执行:
1. 分析当前上下文
2. 执行三步清洗法
3. 生成快照文件（HOT_TRACK.md 和 COLD_TRACK.md）
4. 输出统计信息
```

### 2. 执行压缩

```
# 先生成快照
/context-snapshot

# 再执行压缩
/compact

# 新会话需要时加载快照
/load-context
```

### 3. 查询冷轨

当用户请求查询历史信息时（如 "之前试过什么方案"、"XX方案为什么不行"、"查一下冷轨"），自动执行此功能。

**调用方式**：
- 直接对话："之前试过什么认证方案？"
- 手动调用：`/smart-context "关键词"` 或 `/query-cold "关键词"`

**执行步骤**：
1. 读取 `.claude/context/COLD_TRACK.md` 文件
2. 使用 Grep 搜索指定关键词
3. 格式化输出匹配结果

**输出格式**：

```markdown
> 在冷轨中找到 N 条相关记录：

## 墓碑 T01: [死胡同名称]
- **失败原因**: [描述]
- **放弃日期**: YYYY-MM-DD

## 历史片段 (Turn X-Y)
[相关内容摘要]
```

**示例**：

```
用户: 之前试过什么 Session 方案？

Claude: 在冷轨中找到 2 条相关记录：

## 墓碑 T01: Session 存储登录态
- **失败原因**: 分布式部署时 Session 同步问题
- **放弃日期**: 2026-02-21
- **详情**: 尝试使用 express-session，但在多实例部署时出现 Session 不同步...

## 历史片段 (Turn 12-15)
**User**: 用 Session 存储登录状态怎么样？
**Assistant**: 我来实现 Session 存储...
[后续尝试失败的详细记录]
```

### 4. 加载快照

```
/load-context

执行:
1. 读取 HOT_TRACK.md
2. 输出快照内容到当前会话
```

## 错误处理

| 场景 | 处理方式 |
|------|----------|
| HOT_TRACK.md 不存在 | 提示先执行 /context-snapshot |
| COLD_TRACK.md 不存在 | 创建新文件 |
| context 目录不存在 | 自动创建 |
| Token 超限 | 按优先级裁剪 |

## 与其他 Skill 的集成

| Skill | 集成方式 |
|-------|----------|
| **feature-list-tracker** | 快照可引用 Feature ID |
| **known-issues-tracker** | 墓碑可关联 Issue ID |
| **human-test-guide** | 压缩后可生成测试指导 |
| **strategic-compact** | 建议压缩时机 |

## 最佳实践

### 何时压缩

- 上下文超过 70% 窗口时
- 完成一个阶段性任务后
- 开始新的功能开发前
- 遇到"注意力稀释"症状时

### 如何写高质量墓碑

Bad: 用 Session 不行
Good: Session 存储登录态 → 分布式部署时同步问题，改用 JWT

### 如何维护热轨

- 每次压缩前手动更新快照
- 手动编辑添加重要信息
- 定期清理过时的决策

## 命令总结

| 命令 | 用途 | 自动化程度 |
|------|------|-----------|
| `/context-snapshot` | 生成快照（三步清洗法） | 手动 |
| `/load-context` | 加载快照到当前会话 | 手动 |
| `/compact` | 执行压缩（Claude Code 内置） | 手动 |

> **Note**: 查询冷轨的功能已整合到此 skill 中。直接说 "之前试过什么方案" 或调用 `/smart-context "关键词"` 即可。

## 技术限制

1. **PreCompact Agent Hook 不支持** - 在非 REPL 环境下无法使用 agent 类型 hook
2. **无自动注入** - 为避免旧快照污染新会话，采用完全手动流程
3. **Token 估算不精确** - 使用字符估算，非精确计算
4. **冷轨查询基于 Grep** - 不支持语义搜索

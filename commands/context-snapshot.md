# Context Snapshot - 手动生成快照

---
name: context-snapshot
description: 手动生成上下文快照，通过三步清洗法压缩对话为高信噪比快照
triggers:
  - context-snapshot|生成快照|预览快照|手动快照
---

## 使用方式

```
/context-snapshot
```

## 功能

手动触发三步清洗法，生成热轨快照和冷轨归档，但不执行压缩。

**适用场景**：
- 预览快照内容
- 在压缩前生成快照
- 调试三步清洗法效果

---

## 执行步骤

### Step 1: 无损提取 — 抽骨架

**目标**：从杂乱对话中提取"沉淀下来的资产"

**提取规则**：

| 内容类型 | 提取方式 | 示例 |
|----------|----------|------|
| 函数定义 | 只保留签名 | `def calc(a: int, b: int) -> int` |
| 类定义 | 只保留属性和方法签名 | 删除方法体 |
| API 端点 | 只保留路由和参数定义 | 删除处理逻辑 |
| 数据模型 | 只保留字段定义 | 删除默认值逻辑 |

**执行过程**：
1. 扫描所有代码相关内容（工具调用、代码块）
2. 识别最终版本的接口（中间版本丢弃）
3. 提取函数签名、类型定义、API 路由
4. 生成骨架，不包含实现细节

### Step 2: 有损修剪 — 立墓碑

**目标**：识别失败尝试，生成避坑指南

**死胡同识别模式**：

```
信号词：
- 假设提出："试试"、"也许"、"尝试一下"
- 尝试实施："我改了"、"修改为"、"实现了一下"
- 明确失败："不行"、"还是报错"、"没解决"
- 放弃方案："换一种"、"改用"、"算了"

匹配模式：[假设] + [尝试] + [失败] + [放弃] = 死胡同
```

**墓碑格式**：

```markdown
| 死胡同 | 失败原因 | 日期 |
|--------|----------|------|
| [方案名称] | [一句话说明为什么不行] | [日期] |
```

**执行过程**：
1. 遍历对话历史，识别死胡同模式
2. 为每个死胡同生成墓碑（< 50 字）
3. 将详细失败过程写入冷轨
4. 保留墓碑到热轨

### Step 3: 生成快照 + 归档

**目标**：组装热轨快照，确保大小可控

**Token 估算规则**：

```
混合 Token 估算：
- 英文/代码/符号：1 Token ≈ 4 字符
- 中文/日文/韩文：1 Token ≈ 1.5 字符

估算公式：
  chinese_chars = count_chinese(text)
  other_chars = len(text) - chinese_chars
  tokens = (chinese_chars / 1.5) + (other_chars / 4)
```

**裁剪优先级**（接近 6,000 Token 上限时）：

| 优先级 | 内容 | 动作 |
|--------|------|------|
| 1 | 项目目标 + 阻塞 | 完整保留 |
| 2 | 接口骨架 | 压缩（删除参数详情） |
| 3 | 避坑墓碑 | 压缩（只保留死胡同+原因） |
| 4 | 关键决策 | 可删除 |
| 5 | 进度概览 | 可删除 |

**执行过程**：
1. 组装热轨快照（项目状态 + 接口骨架 + 墓碑 + 决策）
2. 估算 Token 数
3. 如果超限，按优先级裁剪
4. 写入 `.claude/context/HOT_TRACK.md`
5. 追加完整历史到 `.claude/context/COLD_TRACK.md`

---

## 热轨快照模板

```markdown
# 热轨快照

_生成时间: YYYY-MM-DD HH:MM_
_快照版本: v{N}_

---

## 1. 项目状态

### 当前目标
[一句话描述]

### 进度概览
| 模块 | 状态 | 说明 |
|------|------|------|
| ... | ... | ... |

### 当下阻塞
- **问题**: [描述]
- **下一步**: [计划]

---

## 2. 已确定接口（骨架）

### {文件名}
```
[接口签名，无实现体]
```

---

## 3. 避坑墓碑

| 死胡同 | 失败原因 | 日期 |
|--------|----------|------|
| [方案] | [一句话] | [日期] |

---

## 4. 关键决策

| 决策 | 理由 | 日期 |
|------|------|------|
| [选择] | [原因] | [日期] |

---
*Token 数: ~{N}*
```

---

## 冷轨归档模板

```markdown
# 冷轨归档

_创建时间: YYYY-MM-DD_

---

## 墓碑区

### T01: [死胡同名称]
- **失败原因**: [描述]
- **放弃日期**: YYYY-MM-DD
- **尝试过程**:
  [详细的失败过程记录]

---

## 历史记录区

### Session: YYYY-MM-DD

#### Turn 1 - HH:MM
**User**: [内容]
**Assistant**: [内容]
**Tools**: [工具调用]
```

---

## 输出示例

```
快照生成完成！

文件位置：
- 热轨快照: .claude/context/HOT_TRACK.md (~1,500 Token)
- 冷轨归档: .claude/context/COLD_TRACK.md

包含内容：
- 项目状态: 1 个目标, 1 个阻塞
- 接口骨架: 3 个文件
- 避坑墓碑: 2 条
- 关键决策: 1 条

下一步: 执行 /compact 进行压缩。新会话需要时执行 /load-context 加载快照。
```

---

## 与 /compact 的区别

| 操作 | /context-snapshot | /compact |
|------|-------------------|----------|
| 生成快照 | ✓ | ✗ |
| 执行压缩 | ✗ | ✓ |
| 适用场景 | 生成快照 | 压缩上下文 |

**推荐流程**：
1. `/context-snapshot` - 生成快照
2. `/compact` - 执行压缩
3. `/load-context` - 新会话需要时加载快照

---

## 注意事项

- 手动生成的快照会被后续压缩流程使用
- Token 限制：热轨快照 < 6,000 Token
- 冷轨无大小限制，完整记录历史
- 如果快照已存在，会覆盖旧版本
